// prisma/schema.prisma

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = "mongodb+srv://seven007:seven007@poaap.f0mxo.mongodb.net/music_collection?retryWrites=true&w=majority"
}

model User {
  id        String    @id @default(auto()) @map("_id") @db.ObjectId
  email     String    @unique
  name      String
  role      Role      @default(STUDENT)
  password  String
  createdAt DateTime  @default(now())
  updatedAt DateTime? @updatedAt // ✅ Thêm ? để optional

  files      File[]     @relation("FileOwner")
  categories Category[] @relation("CategoryOwner")
  lessons    Lesson[]   @relation("LessonOwner")

  @@index([role])
}

enum Role {
  ADMIN
  TEACHER
  STUDENT
  CONTRIBUTOR
}

model File {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  filename    String
  publicId    String?
  url         String
  downloadUrl String?
  type        String
  size        Int
  src         String?
  detail      Json?
  name        String?
  description String?
  
  categoryId  String?   @db.ObjectId
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  classes     Int[]     @default([])
  
  ownerId     String?   @db.ObjectId
  owner       User?     @relation("FileOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  ownerName   String?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt // ✅ Thêm ?

  @@index([categoryId])
  @@index([ownerId])
  @@index([type])
  @@index([createdAt])
}

model Category {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  name        String
  slug        String    @unique
  description String?
  
  ownerId     String?   @db.ObjectId
  owner       User?     @relation("CategoryOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  files       File[]
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt // ✅ Thêm ?

  @@index([ownerId])
}

model Lesson {
  id          String    @id @default(auto()) @map("_id") @db.ObjectId
  title       String
  description String?
  
  ownerId     String    @db.ObjectId
  owner       User      @relation("LessonOwner", fields: [ownerId], references: [id], onDelete: Cascade)
  ownerName   String
  
  fileIds     String[]  @db.ObjectId @default([])
  
  classId     Int?
  
  createdAt   DateTime  @default(now())
  updatedAt   DateTime? @updatedAt // ✅ Thêm ?

  @@index([ownerId])
  @@index([createdAt])
}